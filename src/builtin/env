#include "../Libft/libft.h"
#include <stdio.h>

typedef struct s_mini
{
	char    **env;
	int     env_len;
} t_mini;

void	free_split(char **split)
{
	int		i;

	i = 0;
	while (split[i] != NULL)
		i++;
	i--;
	while (i >= 1)
	{
		printf("free: %d\n", i);
		free(split[i]);
		i--;
	}
	printf("free final: %d\n", i);
	//free(split);
}

/* recive el nombre de una variable y devuelve su contenido */
char    *expand_env(char *env_var, char **envp)
{
	char    *var;
	char    *tmp;
	int     i;

	i = 0;
	tmp = ft_strjoin(env_var, "=");
	while (envp[i])
	{
		var = ft_strnstr(envp[i] + 1, tmp, ft_strlen(tmp));
		if (var)
		{
			var = ft_strdup(envp[i] + ft_strlen(tmp) + 1);
			break ;
		}
		free(var);
		i++;
	}
	free(tmp);
	return (var);
}

void	init_env(t_mini *mini, char **envp)
{
	mini->env_len = 0;
	while (envp[mini->env_len])
		mini->env_len++;
	mini->env = malloc(sizeof(char *) * mini->env_len + 2);
	mini->env_len = 0;
	mini->env[0] = ft_strdup("v?=0");
	while (envp[mini->env_len])
	{
		mini->env[mini->env_len + 1] = ft_strjoin("e", envp[mini->env_len]);
		mini->env_len++;
	}
	mini->env[mini->env_len + 1] = '\0';
}

void	print_env(t_mini *mini)
{
	int		i;

	i = 0;
	while (mini->env[i])
	{
		if (mini->env[i][0] == 'e')
			printf("%s\n", mini->env[i] + 1);
		i++;
	}
}

void	add_env(t_mini *mini, char *env_var)
{
	char	**new;
	int		i;

	i = 0;
	new = malloc(sizeof(char *) *mini->env_len + 2);
	while(mini->env[i])
	{
		new[i] = mini->env[i];
		i++;
	}
	new[i] = ft_strdup(env_var);
	i++;
	new[i] = '\0';
	free_split(mini->env);
	mini->env = new;
}

//void	add_env(t_mini *mini, char *env_var)
//{
	// char	**tmp;
	// int		i;

	// i = 0;
	// tmp = mini->env;
	// //free_split(mini->env);
	// mini->env = malloc(sizeof(char *) * mini->env_len + 2);
	// while (tmp[i])
	// {
	// 	//free(mini->env[i]);
	// 	mini->env[i] = tmp[i];
	// 	i++;
	// }
	// mini->env[i] = ft_strdup(env_var);
	// i++;
	// mini->env[i] = '\0';
//}

int main(int argc, char **argv, char **envp)
{
	char    *str;
	int     *len;
	char    **split;
	t_mini	mini;

	init_env(&mini, envp);
	str = expand_env(argv[1], mini.env);
	if (str)
		printf("%s\n", str);
	//print_env(&mini);
	add_env(&mini, "eVAAARRR=hola");
	print_env(&mini);
	free(str);
	return (1);
}
